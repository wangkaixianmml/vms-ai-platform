import React, { useEffect, useState } from 'react';
import { Table, Tag, Space, Button, Input, Select, Card, Typography, Modal, Form, message } from 'antd';
import { SearchOutlined, PlusOutlined, RobotOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
import AIChatTrigger from '../../components/ai/AIChatTrigger';
import vulnerabilityService from '../../services/vulnerabilityService';

const { Title } = Typography;
const { Option } = Select;
const { TextArea } = Input;

interface Asset {
  id: number;
  name: string;
  ip: string | null;
  type: string;
}

interface Vulnerability {
  id: number;
  name: string;
  cve_id: string | null;
  risk_level: string;
  description: string;
  affected_assets: Asset[];
  discovery_date: string;
  status: string;
  remediation_steps: string | null;
}

// 风险等级对应的颜色
const riskLevelColors: Record<string, string> = {
  '高': 'red',
  '中': 'orange',
  '低': 'green',
};

// 状态对应的颜色
const statusColors: Record<string, string> = {
  '待修复': 'red',
  '修复中': 'orange',
  '已修复': 'green',
  '已验证': 'blue',
};

const VulnerabilityList: React.FC = () => {
  const navigate = useNavigate();
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchText, setSearchText] = useState('');
  const [riskLevelFilter, setRiskLevelFilter] = useState<string>('');
  const [statusFilter, setStatusFilter] = useState<string>('');
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [form] = Form.useForm();
  const [submitLoading, setSubmitLoading] = useState(false);

  useEffect(() => {
    const fetchVulnerabilities = async () => {
      try {
        setLoading(true);
        // 构建请求参数
        const params: any = {};
        
        if (riskLevelFilter) {
          params.risk_level = riskLevelFilter;
        }
        
        if (statusFilter) {
          params.status = statusFilter;
        }
        
        console.log('正在获取漏洞列表，参数:', params);
        
        const data = await vulnerabilityService.getVulnerabilities(params);
        console.log('获取到漏洞数据:', data);
        
        if (!Array.isArray(data)) {
          console.error('返回的数据不是数组:', data);
          throw new Error('API返回的数据格式不正确');
        }
        
        setVulnerabilities(data);
      } catch (error) {
        console.error('获取漏洞列表出错:', error);
        message.error('获取漏洞列表失败，请检查网络连接或刷新页面');
        // 确保即使失败也清空之前的数据，以防止显示过期数据
        setVulnerabilities([]);
      } finally {
        setLoading(false);
      }
    };

    fetchVulnerabilities();
  }, [riskLevelFilter, statusFilter]);

  // 导航到漏洞详情页
  const goToDetail = (id: number) => {
    navigate(`/vulnerabilities/${id}`);
  };

  // 过滤显示的漏洞
  const filteredVulnerabilities = vulnerabilities.filter(v => 
    v.name.toLowerCase().includes(searchText.toLowerCase()) ||
    (v.cve_id && v.cve_id.toLowerCase().includes(searchText.toLowerCase())) ||
    v.description.toLowerCase().includes(searchText.toLowerCase())
  );

  // 添加漏洞
  const handleAddVulnerability = () => {
    setIsModalVisible(true);
  };

  // 处理表单提交
  const handleSubmit = async (values: any) => {
    try {
      setSubmitLoading(true);
      console.log('提交表单数据:', values);
      
      const data = await vulnerabilityService.createVulnerability(values);
      
      // 添加新漏洞到列表
      setVulnerabilities(prev => [...prev, data]);
      
      // 关闭模态窗口并重置表单
      setIsModalVisible(false);
      form.resetFields();
      
      message.success('漏洞添加成功！');
    } catch (error) {
      console.error('创建漏洞出错:', error);
      message.error('漏洞添加失败，请稍后重试');
    } finally {
      setSubmitLoading(false);
    }
  };

  // 取消添加
  const handleCancel = () => {
    setIsModalVisible(false);
    form.resetFields();
  };

  const columns = [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
      width: 70,
    },
    {
      title: '名称',
      dataIndex: 'name',
      key: 'name',
      render: (text: string, record: Vulnerability) => (
        <a onClick={() => goToDetail(record.id)}>{text}</a>
      ),
    },
    {
      title: 'CVE ID',
      dataIndex: 'cve_id',
      key: 'cve_id',
      render: (text: string | null) => text || '无',
    },
    {
      title: '风险等级',
      dataIndex: 'risk_level',
      key: 'risk_level',
      render: (text: string) => (
        <Tag color={riskLevelColors[text] || 'default'}>{text}</Tag>
      ),
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (text: string) => (
        <Tag color={statusColors[text] || 'default'}>{text}</Tag>
      ),
    },
    {
      title: '影响资产',
      key: 'affected_assets',
      dataIndex: 'affected_assets',
      render: (assets: Asset[]) => (
        <span>{assets.length > 0 ? `${assets.length}个资产` : '无'}</span>
      ),
    },
    {
      title: '操作',
      key: 'action',
      render: (_: any, record: Vulnerability) => (
        <Space size="small">
          <Button type="link" size="small" onClick={() => goToDetail(record.id)}>
            详情
          </Button>
          <AIChatTrigger 
            buttonText="AI分析" 
            data={record} 
            buttonType="link" 
            size="small" 
            placement="list"
            icon={<RobotOutlined />}
          />
        </Space>
      ),
    },
  ];

  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <Title level={2}>漏洞管理</Title>
        <Button type="primary" icon={<PlusOutlined />} onClick={handleAddVulnerability}>
          添加漏洞
        </Button>
      </div>

      <Card className="mb-4">
        <div className="flex flex-wrap gap-4">
          <Input
            placeholder="搜索漏洞名称、CVE或描述"
            value={searchText}
            onChange={e => setSearchText(e.target.value)}
            style={{ width: 300 }}
            prefix={<SearchOutlined />}
            allowClear
          />
          
          <Select
            placeholder="风险等级"
            style={{ width: 120 }}
            value={riskLevelFilter || undefined}
            onChange={value => setRiskLevelFilter(value)}
            allowClear
          >
            <Option value="高">高</Option>
            <Option value="中">中</Option>
            <Option value="低">低</Option>
          </Select>
          
          <Select
            placeholder="状态"
            style={{ width: 120 }}
            value={statusFilter || undefined}
            onChange={value => setStatusFilter(value)}
            allowClear
          >
            <Option value="待修复">待修复</Option>
            <Option value="修复中">修复中</Option>
            <Option value="已修复">已修复</Option>
            <Option value="已验证">已验证</Option>
          </Select>
        </div>
      </Card>

      <Table
        columns={columns}
        dataSource={filteredVulnerabilities}
        rowKey="id"
        loading={loading}
        pagination={{ pageSize: 10 }}
      />

      {/* 添加漏洞模态窗口 */}
      <Modal
        title="添加新漏洞"
        open={isModalVisible}
        onCancel={handleCancel}
        footer={null}
        maskClosable={false}
        width={700}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={handleSubmit}
          initialValues={{
            risk_level: '中',
            affected_assets: [],
          }}
        >
          <Form.Item
            name="name"
            label="漏洞名称"
            rules={[{ required: true, message: '请输入漏洞名称' }]}
          >
            <Input placeholder="输入漏洞名称" />
          </Form.Item>
          
          <Form.Item
            name="cve_id"
            label="CVE编号"
          >
            <Input placeholder="输入CVE编号(如有)" />
          </Form.Item>
          
          <Form.Item
            name="risk_level"
            label="风险等级"
            rules={[{ required: true, message: '请选择风险等级' }]}
          >
            <Select>
              <Option value="高">高</Option>
              <Option value="中">中</Option>
              <Option value="低">低</Option>
            </Select>
          </Form.Item>
          
          <Form.Item
            name="description"
            label="漏洞描述"
            rules={[{ required: true, message: '请输入漏洞描述' }]}
          >
            <TextArea rows={4} placeholder="输入漏洞详细描述" />
          </Form.Item>
          
          <Form.Item
            name="remediation_steps"
            label="修复步骤"
          >
            <TextArea rows={3} placeholder="输入修复步骤(可选)" />
          </Form.Item>
          
          <Form.Item>
            <div className="flex justify-end">
              <Button style={{ marginRight: 8 }} onClick={handleCancel}>
                取消
              </Button>
              <Button type="primary" htmlType="submit" loading={submitLoading}>
                提交
              </Button>
            </div>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default VulnerabilityList;